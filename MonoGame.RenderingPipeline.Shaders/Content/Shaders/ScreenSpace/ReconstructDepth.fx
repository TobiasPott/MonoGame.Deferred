//Depth Reconstruction from linear depth buffer, TheKosmonaut 2016

#include "../../Includes/Macros.incl.fx"
#define _DEPTH_MAP
#include "../../Includes/Maps.incl.fx"
#include "../../Includes/VertexStage.incl.fx"

////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  VARIABLES
////////////////////////////////////////////////////////////////////////////////////////////////////////////

float4x4 Projection;


SamplerState texSampler
{
    Texture = (DepthMap);
    AddressU = CLAMP;
    AddressV = CLAMP;
    MagFilter = POINT;
    MinFilter = POINT;
    Mipfilter = POINT;
};
 
////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  HELPER FUNCTIONS
////////////////////////////////////////////////////////////////////////////////////////////////////////////

float TransformDepth(float depth, matrix trafoMatrix)
{
	return (depth*trafoMatrix._33 + trafoMatrix._43) / (depth * trafoMatrix._34 + trafoMatrix._44);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  VERTEX SHADER
////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  PIXEL SHADER
////////////////////////////////////////////////////////////////////////////////////////////////////////////

#ifdef DX10_OR_NEWER
float PixelShaderFunction(VSOut_PosTex input) : SV_Depth
#else
float4 PixelShaderFunction(VSOut_PosTex input) : SV_TARGET0
#endif
{
	float2 texCoord = float2(input.TexCoord);

	float linearDepth = DepthMap.Sample(texSampler, texCoord).r * -FarClip;

    return float4(TransformDepth(linearDepth, Projection), 0, 0, 0);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  TECHNIQUES
////////////////////////////////////////////////////////////////////////////////////////////////////////////

technique RestoreDepth
{
	pass Pass1
	{
		COMPILE_VS(VSMain_Encoded);
		COMPILE_PS(PixelShaderFunction);
	}
}

